<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhishGuard - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-shield-alt"></i> PhishGuard</h2>
            </div>
            <div class="sidebar-user">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-info">
                    <span id="username">Loading...</span>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li class="active" data-tab="home">
                    <a href="#"><i class="fas fa-home"></i> Home</a>
                </li>
                <li data-tab="history">
                    <a href="#"><i class="fas fa-history"></i> History</a>
                </li>
                <li data-tab="analyzer">
                    <a href="#"><i class="fas fa-search"></i> Text Analyzer</a>
                </li>
                <li id="logoutBtn">
                    <a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Dashboard</h1>
            </div>

            <div class="tab-content active" id="home-tab">
                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-card-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="stat-card-info">
                            <h3>Total Scans</h3>
                            <p id="totalScans">Loading...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-card-info">
                            <h3>Phishing Detected</h3>
                            <p id="phishingCount">Loading...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-card-info">
                            <h3>Safe Content</h3>
                            <p id="safeCount">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>Phishing Detection Results</h2>
                    <canvas id="resultsChart"></canvas>
                </div>

                <div class="recent-activity">
                    <h2>Recent Activity</h2>
                    <div class="activity-list" id="recentActivity">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="history-tab">
                <div class="search-filter">
                    <input type="text" id="historySearch" placeholder="Search in history...">
                    <select id="resultFilter">
                        <option value="all">All Results</option>
                        <option value="Phishing">Phishing</option>
                        <option value="Safe">Safe</option>
                    </select>
                </div>

                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Text</th>
                                <th>Result</th>
                                <th>NLP Model 1</th>
                                <th>NLP Model 2</th>
                                <th>LLM Model 1</th>
                                <th>LLM Model 2</th>
                                <th>Final Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="8" class="loading-cell">
                                    <i class="fas fa-spinner fa-spin"></i> Loading history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="analyzer-tab">
                <div class="analyzer-container">
                    <h2>Phishing Text Analyzer</h2>
                    <p>Enter or paste text to analyze for phishing content:</p>
                    
                    <div class="form-group">
                        <textarea id="textToAnalyze" rows="8" placeholder="Enter text to analyze..."></textarea>
                    </div>
                    
                    <div class="analysis-options">
                        <div class="analysis-method">
                            <label>Analysis Method:</label>
                            <div class="method-options">
                                <label class="method-option">
                                    <input type="checkbox" name="nlp_model1" checked> 
                                    <span>NLP Model 1 (Keyword Analysis)</span>
                                </label>
                                <label class="method-option">
                                    <input type="checkbox" name="nlp_model2" checked> 
                                    <span>NLP Model 2 (Statistical Analysis)</span>
                                </label>
                                <label class="method-option">
                                    <input type="checkbox" name="llm_model1" checked> 
                                    <span>LLM Model 1 (Llama 3.3)</span>
                                </label>
                                <label class="method-option">
                                    <input type="checkbox" name="llm_model2" checked> 
                                    <span>LLM Model 2 (Gemma 2)</span>
                                </label>
                            </div>
                            <div class="preset-buttons">
                                <button id="allModels" class="preset-btn active">All Models</button>
                                <button id="nlpOnly" class="preset-btn">NLP Only (Fast)</button>
                                <button id="llmOnly" class="preset-btn">LLM Only (Accurate)</button>
                            </div>
                        </div>
                        <div class="save-option">
                            <input type="checkbox" id="saveAnalysis" checked>
                            <label for="saveAnalysis">Save analysis to history</label>
                        </div>
                    </div>
                    
                    <button id="analyzeBtn" class="btn primary-btn">
                        <i class="fas fa-search"></i> Analyze Text
                    </button>
                    
                    <div id="analysisResult" class="analysis-result hidden">
                        <div class="result-header">
                            <h3>Analysis Result</h3>
                            <span id="resultBadge" class="badge"></span>
                        </div>
                        
                        <div class="confidence-meters">
                            <div class="confidence-meter" id="nlpModel1Container">
                                <label>NLP Model 1:</label>
                                <div class="meter-container">
                                    <div id="nlpModel1Meter" class="meter"></div>
                                    <span id="nlpModel1Confidence">0%</span>
                                </div>
                            </div>
                            
                            <div class="confidence-meter" id="nlpModel2Container">
                                <label>NLP Model 2:</label>
                                <div class="meter-container">
                                    <div id="nlpModel2Meter" class="meter"></div>
                                    <span id="nlpModel2Confidence">0%</span>
                                </div>
                            </div>
                            
                            <div class="confidence-meter" id="llmModel1Container">
                                <label>LLM Model 1:</label>
                                <div class="meter-container">
                                    <div id="llmModel1Meter" class="meter"></div>
                                    <span id="llmModel1Confidence">0%</span>
                                </div>
                            </div>
                            
                            <div class="confidence-meter" id="llmModel2Container">
                                <label>LLM Model 2:</label>
                                <div class="meter-container">
                                    <div id="llmModel2Meter" class="meter"></div>
                                    <span id="llmModel2Confidence">0%</span>
                                </div>
                            </div>
                            
                            <div class="confidence-meter">
                                <label>Final Confidence:</label>
                                <div class="meter-container">
                                    <div id="finalMeter" class="meter"></div>
                                    <span id="finalConfidence">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="reasoningContainer" class="reasoning-container hidden">
                            <button id="toggleReasoning" class="toggle-btn">Show AI Reasoning</button>
                            <div id="reasoningContent" class="reasoning-content hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detail View Modal -->
            <div id="detailModal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Analysis Details</h3>
                    <div class="detail-body">
                        <div class="detail-text"></div>
                        <div class="detail-result"></div>
                        <div class="detail-models"></div>
                        <div class="detail-reasoning"></div>
                        <div class="detail-indicators"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            loadDashboardData();
            setupTabNavigation();
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            setupAnalyzer();
            setupHistoryFilters();
            setupModal();
        });

        function logout() {
            localStorage.removeItem('jwtToken');
            
            try {
                chrome.storage.local.remove('jwtToken', function() {
                    console.log('Token removed from chrome.storage');
                });
            } catch (error) {
                console.log('Chrome storage not available', error);
            }
            
            sessionStorage.clear();
            window.location.href = '/login';
        }
        
        async function loadDashboardData() {
            const token = localStorage.getItem('jwtToken');
            try {
                const response = await fetch(`/get_dashboard_data?token=${token}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('username').textContent = data.username;
                    
                    const totalScans = data.results.length;
                    const phishingCount = data.results.filter(r => r.phishing_result === 'Phishing').length;
                    const safeCount = data.results.filter(r => r.phishing_result === 'Safe').length;
                    
                    document.getElementById('totalScans').textContent = totalScans;
                    document.getElementById('phishingCount').textContent = phishingCount;
                    document.getElementById('safeCount').textContent = safeCount;
                    
                    createResultsChart(phishingCount, safeCount);
                    populateRecentActivity(data.results.slice(0, 5));
                    populateHistoryTable(data.results);
                    
                    window.allResults = data.results;
                    window.modelNames = data.models || {
                        nlp_model1: "NLP Model 1",
                        nlp_model2: "NLP Model 2",
                        llm_model1: "LLM Model 1",
                        llm_model2: "LLM Model 2"
                    };
                } else {
                    console.error('Failed to load dashboard data');
                    if (response.status === 401) {
                        localStorage.removeItem('jwtToken');
                        window.location.href = '/login';
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        function createResultsChart(phishingCount, safeCount) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Phishing', 'Safe'],
                    datasets: [{
                        data: [phishingCount, safeCount],
                        backgroundColor: ['#ff6b6b', '#51cf66'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function populateRecentActivity(results) {
            const activityList = document.getElementById('recentActivity');
            activityList.innerHTML = '';
            
            if (results.length === 0) {
                activityList.innerHTML = '<div class="no-data">No activity yet</div>';
                return;
            }
            
            results.forEach(result => {
                const truncatedText = result.selected_text.length > 50 
                    ? result.selected_text.substring(0, 50) + '...' 
                    : result.selected_text;
                
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const resultClass = result.phishing_result === 'Phishing' ? 'danger' : 'success';
                const resultIcon = result.phishing_result === 'Phishing' 
                    ? 'exclamation-triangle' 
                    : 'check-circle';
                
                activityItem.innerHTML = `
                    <div class="activity-icon ${resultClass}">
                        <i class="fas fa-${resultIcon}"></i>
                    </div>
                    <div class="activity-details">
                        <p>${truncatedText}</p>
                        <span class="activity-result ${resultClass}">
                            ${result.phishing_result} (${Math.round(result.final_confidence * 100)}%)
                        </span>
                    </div>
                `;
                
                activityList.appendChild(activityItem);
            });
        }
        
        function populateHistoryTable(results) {
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            
            if (results.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" class="no-data">No history data available</td>';
                tableBody.appendChild(tr);
                return;
            }
            
            results.forEach(result => {
                const tr = document.createElement('tr');
                
                const resultClass = result.phishing_result === 'Phishing' ? 'danger' : 'success';
                
                tr.innerHTML = `
                    <td class="text-cell">${result.selected_text}</td>
                    <td class="result-cell">
                        <span class="result-badge ${resultClass}">
                            ${result.phishing_result}
                        </span>
                    </td>
                    <td>${formatPercentage(result.nlp_model1_confidence)}</td>
                    <td>${formatPercentage(result.nlp_model2_confidence)}</td>
                    <td>${formatPercentage(result.llm_model1_confidence)}</td>
                    <td>${formatPercentage(result.llm_model2_confidence)}</td>
                    <td>${formatPercentage(result.final_confidence)}</td>
                    <td>
                        <button class="view-btn" data-id="${result.id}">View</button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            const viewButtons = document.querySelectorAll('.view-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showDetails(id);
                });
            });
        }
        
        function formatPercentage(value) {
            if (isNaN(value) || value === null) return "N/A";
            return (value * 100).toFixed(1) + '%';
        }
        
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.sidebar-menu li[data-tab]');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        

        function setupAnalyzer() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const modelCheckboxes = document.querySelectorAll('.method-option input');
    const presetButtons = document.querySelectorAll('.preset-btn');
    const allModelsBtn = document.getElementById('allModels');
    const nlpOnlyBtn = document.getElementById('nlpOnly');
    const llmOnlyBtn = document.getElementById('llmOnly');
    
    // Set up preset buttons
    allModelsBtn.addEventListener('click', function() {
        setActivePreset(this);
        modelCheckboxes.forEach(checkbox => checkbox.checked = true);
    });
    
    nlpOnlyBtn.addEventListener('click', function() {
        setActivePreset(this);
        modelCheckboxes.forEach(checkbox => {
            if (checkbox.name.startsWith('nlp')) {
                checkbox.checked = true;
            } else {
                checkbox.checked = false;
            }
        });
    });
    
    llmOnlyBtn.addEventListener('click', function() {
        setActivePreset(this);
        modelCheckboxes.forEach(checkbox => {
            if (checkbox.name.startsWith('llm')) {
                checkbox.checked = true;
            } else {
                checkbox.checked = false;
            }
        });
    });
    
    // When individual checkboxes are changed, update active preset
    modelCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateActivePreset);
    });
    
    // Handle analysis button click
    analyzeBtn.addEventListener('click', async function() {
        const textToAnalyze = document.getElementById('textToAnalyze').value.trim();
        if (!textToAnalyze) {
            alert('Please enter text to analyze');
            return;
        }
        
        // Get selected models
        const selectedModels = getSelectedModels();
        if (Object.keys(selectedModels).length === 0) {
            alert('Please select at least one model for analysis');
            return;
        }
        
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        
        const saveAnalysis = document.getElementById('saveAnalysis').checked;
        
        try {
            const token = localStorage.getItem('jwtToken');
            const response = await fetch('/analyze_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    jwt_token: token,
                    selected_text: textToAnalyze,
                    email_data: {
                        subject: "Text Analysis",
                        from: "Manual Input"
                    },
                    models: selectedModels,
                    save_analysis: saveAnalysis
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                displayAnalysisResult(data, selectedModels);
                setupReasoningToggle(); // Setup the toggle button after displaying results
                
                if (saveAnalysis) {
                    loadDashboardData();
                }
            } else {
                alert(data.message || 'Analysis failed');
            }
        } catch (error) {
            console.error('Analysis error:', error);
            alert('An error occurred during analysis');
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Text';
        }
    });
}

// Separate function to set up the reasoning toggle
function setupReasoningToggle() {
    const toggleReasoningBtn = document.getElementById('toggleReasoning');
    if (toggleReasoningBtn) {
        // Remove any existing event listeners by cloning and replacing the button
        const newToggleBtn = toggleReasoningBtn.cloneNode(true);
        toggleReasoningBtn.parentNode.replaceChild(newToggleBtn, toggleReasoningBtn);
        
        newToggleBtn.addEventListener('click', function() {
            const reasoningContent = document.getElementById('reasoningContent');
            if (reasoningContent.classList.contains('hidden')) {
                reasoningContent.classList.remove('hidden');
                this.textContent = 'Hide AI Reasoning';
            } else {
                reasoningContent.classList.add('hidden');
                this.textContent = 'Show AI Reasoning';
            }
        });
    }
}

function setActivePreset(button) {
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
}

function updateActivePreset() {
    const checkboxes = document.querySelectorAll('.method-option input');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const onlyNLP = Array.from(checkboxes).filter(cb => cb.name.startsWith('nlp')).every(cb => cb.checked) &&
                    Array.from(checkboxes).filter(cb => cb.name.startsWith('llm')).every(cb => !cb.checked);
    const onlyLLM = Array.from(checkboxes).filter(cb => cb.name.startsWith('llm')).every(cb => cb.checked) &&
                   Array.from(checkboxes).filter(cb => cb.name.startsWith('nlp')).every(cb => !cb.checked);
    
    document.getElementById('allModels').classList.toggle('active', allChecked);
    document.getElementById('nlpOnly').classList.toggle('active', onlyNLP);
    document.getElementById('llmOnly').classList.toggle('active', onlyLLM);
    
    if (!allChecked && !onlyNLP && !onlyLLM) {
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }
}

function getSelectedModels() {
    const selectedModels = {};
    document.querySelectorAll('.method-option input:checked').forEach(checkbox => {
        selectedModels[checkbox.name] = true;
    });
    return selectedModels;
}

function displayAnalysisResult(data, selectedModels) {
    const resultElement = document.getElementById('analysisResult');
    resultElement.classList.remove('hidden');
    
    // Display result badge
    const resultBadge = document.getElementById('resultBadge');
    resultBadge.textContent = data.result;
    resultBadge.className = 'badge ' + (data.result === 'Phishing' ? 'danger' : 'success');
    
    // Show/hide meter containers based on selected models
    document.getElementById('nlpModel1Container').style.display = 
        selectedModels.nlp_model1 ? 'flex' : 'none';
    document.getElementById('nlpModel2Container').style.display = 
        selectedModels.nlp_model2 ? 'flex' : 'none';
    document.getElementById('llmModel1Container').style.display = 
        selectedModels.llm_model1 ? 'flex' : 'none';
    document.getElementById('llmModel2Container').style.display = 
        selectedModels.llm_model2 ? 'flex' : 'none';
    
    // Update confidence meters
    if (selectedModels.nlp_model1) {
        updateConfidenceMeter('nlpModel1Meter', 'nlpModel1Confidence', data.nlp_model1_confidence);
    }
    if (selectedModels.nlp_model2) {
        updateConfidenceMeter('nlpModel2Meter', 'nlpModel2Confidence', data.nlp_model2_confidence);
    }
    if (selectedModels.llm_model1) {
        updateConfidenceMeter('llmModel1Meter', 'llmModel1Confidence', data.llm_model1_confidence);
    }
    if (selectedModels.llm_model2) {
        updateConfidenceMeter('llmModel2Meter', 'llmModel2Confidence', data.llm_model2_confidence);
    }
    updateConfidenceMeter('finalMeter', 'finalConfidence', data.final_confidence);
    
    // Handle reasoning display if LLM models were selected
    const reasoningContainer = document.getElementById('reasoningContainer');
    const reasoningContent = document.getElementById('reasoningContent');
    
    if ((selectedModels.llm_model1 && data.llm_model1_reason) || 
        (selectedModels.llm_model2 && data.llm_model2_reason)) {
        reasoningContainer.classList.remove('hidden');
        reasoningContent.innerHTML = '';
        
        if (selectedModels.llm_model1 && data.llm_model1_reason) {
            const modelName = window.modelNames?.llm_model1 || "LLM Model 1";
            const reasoning = document.createElement('div');
            reasoning.innerHTML = `
                <h4>${modelName} Analysis:</h4>
                <p>${data.llm_model1_reason}</p>
            `;
            reasoningContent.appendChild(reasoning);
        }
        
        if (selectedModels.llm_model2 && data.llm_model2_reason) {
            const modelName = window.modelNames?.llm_model2 || "LLM Model 2";
            const reasoning = document.createElement('div');
            reasoning.innerHTML = `
                <h4>${modelName} Analysis:</h4>
                <p>${data.llm_model2_reason}</p>
            `;
            reasoningContent.appendChild(reasoning);
        }
        
        // Make sure reasoning content is hidden initially
        reasoningContent.classList.add('hidden');
    } else {
        reasoningContainer.classList.add('hidden');
    }
}







function setActivePreset(button) {
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
}

function updateActivePreset() {
    const checkboxes = document.querySelectorAll('.method-option input');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const onlyNLP = Array.from(checkboxes).filter(cb => cb.name.startsWith('nlp')).every(cb => cb.checked) &&
                    Array.from(checkboxes).filter(cb => cb.name.startsWith('llm')).every(cb => !cb.checked);
    const onlyLLM = Array.from(checkboxes).filter(cb => cb.name.startsWith('llm')).every(cb => cb.checked) &&
                   Array.from(checkboxes).filter(cb => cb.name.startsWith('nlp')).every(cb => !cb.checked);
    
    document.getElementById('allModels').classList.toggle('active', allChecked);
    document.getElementById('nlpOnly').classList.toggle('active', onlyNLP);
    document.getElementById('llmOnly').classList.toggle('active', onlyLLM);
    
    if (!allChecked && !onlyNLP && !onlyLLM) {
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }
}

function getSelectedModels() {
    const selectedModels = {};
    document.querySelectorAll('.method-option input:checked').forEach(checkbox => {
        selectedModels[checkbox.name] = true;
    });
    return selectedModels;
}

function displayAnalysisResult(data, selectedModels) {
    const resultElement = document.getElementById('analysisResult');
    resultElement.classList.remove('hidden');
    
    // Display result badge
    const resultBadge = document.getElementById('resultBadge');
    resultBadge.textContent = data.result;
    resultBadge.className = 'badge ' + (data.result === 'Phishing' ? 'danger' : 'success');
    
    // Show/hide meter containers based on selected models
    document.getElementById('nlpModel1Container').style.display = 
        selectedModels.nlp_model1 ? 'flex' : 'none';
    document.getElementById('nlpModel2Container').style.display = 
        selectedModels.nlp_model2 ? 'flex' : 'none';
    document.getElementById('llmModel1Container').style.display = 
        selectedModels.llm_model1 ? 'flex' : 'none';
    document.getElementById('llmModel2Container').style.display = 
        selectedModels.llm_model2 ? 'flex' : 'none';
    
    // Update confidence meters
    if (selectedModels.nlp_model1) {
        updateConfidenceMeter('nlpModel1Meter', 'nlpModel1Confidence', data.nlp_model1_confidence);
    }
    if (selectedModels.nlp_model2) {
        updateConfidenceMeter('nlpModel2Meter', 'nlpModel2Confidence', data.nlp_model2_confidence);
    }
    if (selectedModels.llm_model1) {
        updateConfidenceMeter('llmModel1Meter', 'llmModel1Confidence', data.llm_model1_confidence);
    }
    if (selectedModels.llm_model2) {
        updateConfidenceMeter('llmModel2Meter', 'llmModel2Confidence', data.llm_model2_confidence);
    }
    updateConfidenceMeter('finalMeter', 'finalConfidence', data.final_confidence);
    
    // Handle reasoning display if LLM models were selected
    const reasoningContainer = document.getElementById('reasoningContainer');
    const reasoningContent = document.getElementById('reasoningContent');
    
    if ((selectedModels.llm_model1 && data.llm_model1_reason) || 
        (selectedModels.llm_model2 && data.llm_model2_reason)) {
        reasoningContainer.classList.remove('hidden');
        reasoningContent.innerHTML = '';
        
        if (selectedModels.llm_model1 && data.llm_model1_reason) {
            const modelName = window.modelNames?.llm_model1 || "LLM Model 1";
            const reasoning = document.createElement('div');
            reasoning.innerHTML = `
                <h4>${modelName} Analysis:</h4>
                <p>${data.llm_model1_reason}</p>
            `;
            reasoningContent.appendChild(reasoning);
        }
        
        if (selectedModels.llm_model2 && data.llm_model2_reason) {
            const modelName = window.modelNames?.llm_model2 || "LLM Model 2";
            const reasoning = document.createElement('div');
            reasoning.innerHTML = `
                <h4>${modelName} Analysis:</h4>
                <p>${data.llm_model2_reason}</p>
            `;
            reasoningContent.appendChild(reasoning);
        }
    } else {
        reasoningContainer.classList.add('hidden');
    }
}
        function displayAnalysisResult(data) {
            const resultElement = document.getElementById('analysisResult');
            resultElement.classList.remove('hidden');
            
            const resultBadge = document.getElementById('resultBadge');
            resultBadge.textContent = data.result;
            resultBadge.className = 'badge ' + (data.result === 'Phishing' ? 'danger' : 'success');
            
            updateConfidenceMeter('nlpModel1Meter', 'nlpModel1Confidence', data.nlp_model1_confidence);
            updateConfidenceMeter('nlpModel2Meter', 'nlpModel2Confidence', data.nlp_model2_confidence);
            updateConfidenceMeter('llmModel1Meter', 'llmModel1Confidence', data.llm_model1_confidence);
            updateConfidenceMeter('llmModel2Meter', 'llmModel2Confidence', data.llm_model2_confidence);
            updateConfidenceMeter('finalMeter', 'finalConfidence', data.final_confidence);
            
            const reasoningContainer = document.getElementById('reasoningContainer');
            const reasoningContent = document.getElementById('reasoningContent');
            const toggleButton = document.getElementById('toggleReasoning');
            
            if (data.llm_model1_reason || data.llm_model2_reason) {
                reasoningContainer.classList.remove('hidden');
                reasoningContent.innerHTML = '';
                
                if (data.llm_model1_reason) {
                    const modelName = window.modelNames?.llm_model1 || "LLM Model 1";
                    const reasoning = document.createElement('div');
                    reasoning.innerHTML = `
                        <h4>${modelName} Analysis:</h4>
                        <p>${data.llm_model1_reason}</p>
                    `;
                    reasoningContent.appendChild(reasoning);
                }
                
                if (data.llm_model2_reason) {
                    const modelName = window.modelNames?.llm_model2 || "LLM Model 2";
                    const reasoning = document.createElement('div');
                    reasoning.innerHTML = `
                        <h4>${modelName} Analysis:</h4>
                        <p>${data.llm_model2_reason}</p>
                    `;
                    reasoningContent.appendChild(reasoning);
                }
                
                toggleButton.addEventListener('click', function() {
                    if (reasoningContent.classList.contains('hidden')) {
                        reasoningContent.classList.remove('hidden');
                        toggleButton.textContent = 'Hide AI Reasoning';
                    } else {
                        reasoningContent.classList.add('hidden');
                        toggleButton.textContent = 'Show AI Reasoning';
                    }
                });
            } else {
                reasoningContainer.classList.add('hidden');
            }
        }
        
        function updateConfidenceMeter(meterId, confidenceId, value) {
            const meter = document.getElementById(meterId);
            const confidenceText = document.getElementById(confidenceId);
            
            if (isNaN(value) || value === null) {
                confidenceText.textContent = 'N/A';
                meter.style.width = '0%';
                return;
            }
            
            meter.style.width = (value * 100) + '%';
            
            if (value >= 0.7) {
                meter.className = 'meter danger';
            } else if (value >= 0.4) {
                meter.className = 'meter warning';
            } else {
                meter.className = 'meter success';
            }
            
            confidenceText.textContent = (value * 100).toFixed(1) + '%';
        }
        
        function setupHistoryFilters() {
            const searchInput = document.getElementById('historySearch');
            const resultFilter = document.getElementById('resultFilter');
            
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterValue = resultFilter.value;
                
                let filteredResults = window.allResults || [];
                
                if (filterValue !== 'all') {
                    filteredResults = filteredResults.filter(r => r.phishing_result === filterValue);
                }
                
                if (searchTerm) {
                    filteredResults = filteredResults.filter(r => 
                        r.selected_text.toLowerCase().includes(searchTerm)
                    );
                }
                
                populateHistoryTable(filteredResults);
            }
            
            searchInput.addEventListener('input', applyFilters);
            resultFilter.addEventListener('change', applyFilters);
        }
        
        function setupModal() {
            const modal = document.getElementById('detailModal');
            const closeBtn = document.querySelector('.close-modal');
            
            closeBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        function showDetails(id) {
            const result = window.allResults.find(r => r.id == id);
            if (!result) return;
            
            const modal = document.getElementById('detailModal');
            const detailText = modal.querySelector('.detail-text');
            const detailResult = modal.querySelector('.detail-result');
            const detailModels = modal.querySelector('.detail-models');
            const detailReasoning = modal.querySelector('.detail-reasoning');
            const detailIndicators = modal.querySelector('.detail-indicators');
            
            detailText.innerHTML = `<h4>Analyzed Text:</h4><div class="text-content">${result.selected_text}</div>`;
            detailResult.innerHTML = `
                <h4>Result: <span class="${result.phishing_result === 'Phishing' ? 'danger-text' : 'success-text'}">${result.phishing_result}</span></h4>
                <p>Severity: ${result.severity}</p>
                <p>Analysis Date: ${result.created_at}</p>
            `;
            
            detailModels.innerHTML = `<h4>Model Confidence Scores:</h4>
                <table class="detail-table">
                    <tr>
                        <th>Model</th>
                        <th>Confidence</th>
                    </tr>
                    <tr>
                        <td>${window.modelNames?.nlp_model1 || "NLP Model 1"}</td>
                        <td>${formatPercentage(result.nlp_model1_confidence)}</td>
                    </tr>
                    <tr>
                        <td>${window.modelNames?.nlp_model2 || "NLP Model 2"}</td>
                        <td>${formatPercentage(result.nlp_model2_confidence)}</td>
                    </tr>
                    <tr>
                        <td>${window.modelNames?.llm_model1 || "LLM Model 1"}</td>
                        <td>${formatPercentage(result.llm_model1_confidence)}</td>
                    </tr>
                    <tr>
                        <td>${window.modelNames?.llm_model2 || "LLM Model 2"}</td>
                        <td>${formatPercentage(result.llm_model2_confidence)}</td>
                    </tr>
                    <tr class="highlight-row">
                        <td>Final Score</td>
                        <td>${formatPercentage(result.final_confidence)}</td>
                    </tr>
                </table>`;
            
            detailReasoning.innerHTML = '';
            if (result.llm_model1_reason || result.llm_model2_reason) {
                detailReasoning.innerHTML += '<h4>AI Reasoning:</h4>';
                
                if (result.llm_model1_reason) {
                    detailReasoning.innerHTML += `
                        <div class="reasoning-block">
                            <h5>${window.modelNames?.llm_model1 || "LLM Model 1"}:</h5>
                            <p>${result.llm_model1_reason}</p>
                        </div>`;
                }
                
                if (result.llm_model2_reason) {
                    detailReasoning.innerHTML += `
                        <div class="reasoning-block">
                            <h5>${window.modelNames?.llm_model2 || "LLM Model 2"}:</h5>
                            <p>${result.llm_model2_reason}</p>
                        </div>`;
                }
            }
            
            detailIndicators.innerHTML = '';
            if (result.indicators && result.indicators.length > 0) {
                detailIndicators.innerHTML += '<h4>Detected Indicators:</h4><ul class="indicators-list">';
                result.indicators.forEach(indicator => {
                    const severityClass = 
                        indicator.severity === 'high' || indicator.severity === 'critical' ? 'danger-text' :
                        indicator.severity === 'medium' ? 'warning-text' :
                        indicator.severity === 'low' ? 'caution-text' : 'info-text';
                    
                    detailIndicators.innerHTML += `
                        <li class="indicator-item">
                            <span class="indicator-type ${severityClass}">${indicator.type}</span>
                            <span class="indicator-desc">${indicator.description}</span>
                        </li>`;
                });
                detailIndicators.innerHTML += '</ul>';
            }
            
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>